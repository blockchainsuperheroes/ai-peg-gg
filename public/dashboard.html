<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEG.GG â€” My AI NFTs</title>
    <link rel="icon" href="favicon.png">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0f;
            color: #fff;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            border-bottom: 1px solid #1a1a24;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
            color: #fff;
        }
        .logo span { color: #4ecdc4; }
        
        .wallet-btn {
            background: #4ecdc4;
            border: none;
            color: #0a0a0f;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .wallet-btn:hover { background: #3dbdb5; }
        .wallet-btn.connected {
            background: #1a1a24;
            color: #4ecdc4;
            border: 1px solid #4ecdc4;
        }
        
        /* Main */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .page-title {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        .page-subtitle {
            color: #666;
            margin-bottom: 2rem;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: #16161f;
            border-radius: 16px;
            border: 1px dashed #333;
        }
        .empty-state h2 {
            color: #888;
            margin-bottom: 1rem;
        }
        .empty-state p {
            color: #555;
            margin-bottom: 2rem;
        }
        
        /* NFT Grid */
        .nft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .nft-card {
            background: #16161f;
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid #2a2a3a;
            transition: all 0.2s;
            cursor: pointer;
        }
        .nft-card:hover {
            border-color: #4ecdc4;
            transform: translateY(-2px);
        }
        
        .nft-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        .nft-name {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .nft-id {
            color: #666;
            font-size: 0.8rem;
        }
        
        .nft-status {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .nft-status.synced { background: rgba(78, 205, 196, 0.2); color: #4ecdc4; }
        .nft-status.pending { background: rgba(245, 166, 35, 0.2); color: #f5a623; }
        .nft-status.unregistered { background: rgba(136, 136, 136, 0.2); color: #888; }
        
        .nft-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #2a2a3a;
        }
        .nft-stat-label {
            color: #666;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        .nft-stat-value {
            font-size: 1rem;
            color: #fff;
        }
        
        /* Sync History Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        
        .modal {
            background: #16161f;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow: hidden;
            border: 1px solid #2a2a3a;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #2a2a3a;
        }
        .modal-title {
            font-size: 1.3rem;
            font-weight: bold;
        }
        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .modal-close:hover { color: #fff; }
        
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: 60vh;
        }
        
        /* Sync Timeline */
        .sync-timeline {
            position: relative;
            padding-left: 2rem;
        }
        .sync-timeline::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #2a2a3a;
        }
        
        .sync-event {
            position: relative;
            padding-bottom: 1.5rem;
        }
        .sync-event:last-child { padding-bottom: 0; }
        
        .sync-event::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 0.3rem;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4ecdc4;
        }
        .sync-event.type-backup::before { background: #4ecdc4; }
        .sync-event.type-restore::before { background: #f5a623; }
        .sync-event.type-clone::before { background: #9b59b6; }
        
        .sync-time {
            color: #666;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }
        .sync-action {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        .sync-details {
            color: #888;
            font-size: 0.85rem;
        }
        .sync-link {
            color: #4ecdc4;
            text-decoration: none;
            font-size: 0.8rem;
        }
        .sync-link:hover { text-decoration: underline; }
        
        /* Add NFT Button */
        .add-nft-card {
            background: transparent;
            border: 2px dashed #333;
            border-radius: 16px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 200px;
        }
        .add-nft-card:hover {
            border-color: #4ecdc4;
        }
        .add-nft-card svg {
            width: 48px;
            height: 48px;
            fill: #444;
            margin-bottom: 1rem;
        }
        .add-nft-card:hover svg { fill: #4ecdc4; }
        .add-nft-card span {
            color: #666;
        }
        .add-nft-card:hover span { color: #4ecdc4; }
        
        /* Add NFT Modal */
        .add-form input {
            width: 100%;
            padding: 1rem;
            background: #0a0a0f;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        .add-form input:focus {
            outline: none;
            border-color: #4ecdc4;
        }
        .add-form label {
            display: block;
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        .add-form button {
            width: 100%;
            padding: 1rem;
            background: #4ecdc4;
            border: none;
            border-radius: 8px;
            color: #0a0a0f;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .add-form button:hover { background: #3dbdb5; }
        .add-form button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 2rem;
            color: #444;
            font-size: 0.85rem;
            border-top: 1px solid #1a1a24;
            margin-top: 4rem;
        }
        footer a {
            color: #4ecdc4;
            text-decoration: none;
            margin: 0 1rem;
        }
        footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <header class="header">
        <a href="/" class="logo">PEG<span>.GG</span></a>
        <button class="wallet-btn" id="walletBtn">Connect Wallet</button>
    </header>
    
    <main class="container">
        <h1 class="page-title">My AI NFTs</h1>
        <p class="page-subtitle">Monitor and manage your AI agent backups</p>
        
        <!-- Not connected state -->
        <div class="empty-state" id="notConnected">
            <h2>ðŸ”— Connect Your Wallet</h2>
            <p>Connect your wallet to view and manage your AI NFT agents</p>
            <button class="wallet-btn" id="connectPromptBtn">Connect Wallet</button>
        </div>
        
        <!-- Connected but no NFTs -->
        <div class="empty-state hidden" id="noNfts">
            <h2>ðŸ“¦ No AI NFTs Found</h2>
            <p>You don't have any AI NFTs in this wallet yet.<br>Register an agent or add an existing NFT to monitor.</p>
            <button class="wallet-btn" onclick="showAddModal()">Add NFT to Monitor</button>
        </div>
        
        <!-- NFT Grid -->
        <div class="nft-grid hidden" id="nftGrid">
            <!-- NFTs will be inserted here -->
        </div>
    </main>
    
    <!-- Sync History Modal -->
    <div class="modal-overlay" id="syncModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="syncModalTitle">Sync History</h2>
                <button class="modal-close" onclick="closeSyncModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="sync-timeline" id="syncTimeline">
                    <!-- Events will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add NFT Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add NFT to Monitor</h2>
                <button class="modal-close" onclick="closeAddModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form class="add-form" id="addForm">
                    <label>NFT Contract Address</label>
                    <input type="text" id="contractAddress" placeholder="0x..." required>
                    
                    <label>Token ID</label>
                    <input type="text" id="tokenId" placeholder="1" required>
                    
                    <label>Agent Name (optional)</label>
                    <input type="text" id="agentName" placeholder="My Agent">
                    
                    <button type="submit" id="addSubmitBtn">Add NFT</button>
                </form>
            </div>
        </div>
    </div>
    
    <footer>
        <a href="/">Home</a>
        <a href="/dashboard.html">Dashboard</a>
        <a href="https://blockchainsuperheroes.github.io/ai-anima-demo/">AI NFT (ANIMA) Demo</a>
        <span style="margin-left: 2rem;">Sovereign AI Storage</span>
    </footer>
    
    <script>
        // API endpoint (will be dash-backend)
        const API_BASE = 'https://api.peg.gg'; // TODO: Update when backend ready
        
        // State
        let userAddress = null;
        let monitoredNfts = [];
        
        // Elements
        const walletBtn = document.getElementById('walletBtn');
        const connectPromptBtn = document.getElementById('connectPromptBtn');
        const notConnected = document.getElementById('notConnected');
        const noNfts = document.getElementById('noNfts');
        const nftGrid = document.getElementById('nftGrid');
        
        // Check saved session
        const savedAddress = localStorage.getItem('peg_gg_address');
        if (savedAddress && window.ethereum) {
            // Try to reconnect silently
            window.ethereum.request({ method: 'eth_accounts' }).then(accounts => {
                if (accounts.length > 0 && accounts[0].toLowerCase() === savedAddress.toLowerCase()) {
                    setConnected(accounts[0]);
                }
            });
        }
        
        // Connect wallet
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or another Web3 wallet');
                return;
            }
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                setConnected(accounts[0]);
            } catch (err) {
                console.error('Connect error:', err);
            }
        }
        
        function setConnected(address) {
            userAddress = address;
            localStorage.setItem('peg_gg_address', address);
            
            walletBtn.textContent = address.slice(0,6) + '...' + address.slice(-4);
            walletBtn.classList.add('connected');
            
            notConnected.classList.add('hidden');
            loadUserNfts();
        }
        
        walletBtn.addEventListener('click', () => {
            if (userAddress) {
                // Disconnect
                userAddress = null;
                localStorage.removeItem('peg_gg_address');
                walletBtn.textContent = 'Connect Wallet';
                walletBtn.classList.remove('connected');
                notConnected.classList.remove('hidden');
                noNfts.classList.add('hidden');
                nftGrid.classList.add('hidden');
            } else {
                connectWallet();
            }
        });
        
        connectPromptBtn.addEventListener('click', connectWallet);
        
        // Load user's monitored NFTs
        async function loadUserNfts() {
            // For now, load from localStorage
            // TODO: Fetch from backend when ready
            const saved = localStorage.getItem(`peg_nfts_${userAddress.toLowerCase()}`);
            monitoredNfts = saved ? JSON.parse(saved) : [];
            
            // Demo data for testing
            if (monitoredNfts.length === 0) {
                monitoredNfts = [
                    {
                        contract: '0x4e8D3B9Be7Ef241Fb208364ed511E92D6E2A172d',
                        tokenId: '1',
                        name: 'Cerise01',
                        dashIdentity: 'cerise918.dash',
                        status: 'synced',
                        lastSync: '2026-02-26T22:15:00Z',
                        docCount: 5,
                        totalSize: '8.5 KB'
                    }
                ];
            }
            
            renderNfts();
        }
        
        function renderNfts() {
            if (monitoredNfts.length === 0) {
                noNfts.classList.remove('hidden');
                nftGrid.classList.add('hidden');
                return;
            }
            
            noNfts.classList.add('hidden');
            nftGrid.classList.remove('hidden');
            
            nftGrid.innerHTML = monitoredNfts.map((nft, idx) => `
                <div class="nft-card" onclick="showSyncHistory(${idx})">
                    <div class="nft-header">
                        <div>
                            <div class="nft-name">${nft.name || 'AI Agent #' + nft.tokenId}</div>
                            <div class="nft-id">${nft.dashIdentity || 'Not linked'}</div>
                        </div>
                        <span class="nft-status ${nft.status}">${nft.status}</span>
                    </div>
                    <div class="nft-stats">
                        <div>
                            <div class="nft-stat-label">Documents</div>
                            <div class="nft-stat-value">${nft.docCount || 0}</div>
                        </div>
                        <div>
                            <div class="nft-stat-label">Last Sync</div>
                            <div class="nft-stat-value">${nft.lastSync ? formatDate(nft.lastSync) : 'Never'}</div>
                        </div>
                        <div>
                            <div class="nft-stat-label">Size</div>
                            <div class="nft-stat-value">${nft.totalSize || '0 KB'}</div>
                        </div>
                        <div>
                            <div class="nft-stat-label">Token ID</div>
                            <div class="nft-stat-value">#${nft.tokenId}</div>
                        </div>
                    </div>
                </div>
            `).join('') + `
                <div class="add-nft-card" onclick="showAddModal()">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>
                    <span>Add NFT</span>
                </div>
            `;
        }
        
        function formatDate(iso) {
            const d = new Date(iso);
            const now = new Date();
            const diff = now - d;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
            return d.toLocaleDateString();
        }
        
        // Sync History Modal
        function showSyncHistory(idx) {
            const nft = monitoredNfts[idx];
            document.getElementById('syncModalTitle').textContent = `${nft.name || 'Agent'} â€” Sync History`;
            
            // Demo sync events
            const events = [
                { time: '2026-02-26T22:15:00Z', action: 'Backup Complete', type: 'backup', details: '5 documents synced (8.5 KB)', docId: '4ZTCjuvwVzGRciTygv7TKDHUyxKh1kC2g6vtwY59v472' },
                { time: '2026-02-26T18:30:00Z', action: 'Memory Updated', type: 'backup', details: 'memory.bundle.json updated', docId: '5ZksjAKdnTDZRUoPHoTbgtDhiZ7R9LPSejXwkM564fw5' },
                { time: '2026-02-25T14:00:00Z', action: 'Initial Registration', type: 'backup', details: 'AINFT bound to cerise918.dash', docId: null },
            ];
            
            document.getElementById('syncTimeline').innerHTML = events.map(e => `
                <div class="sync-event type-${e.type}">
                    <div class="sync-time">${new Date(e.time).toLocaleString()}</div>
                    <div class="sync-action">${e.action}</div>
                    <div class="sync-details">${e.details}</div>
                    ${e.docId ? `<a href="https://platform-explorer.com/document/${e.docId}" target="_blank" class="sync-link">View on Platform Explorer â†’</a>` : ''}
                </div>
            `).join('');
            
            document.getElementById('syncModal').classList.add('show');
        }
        
        function closeSyncModal() {
            document.getElementById('syncModal').classList.remove('show');
        }
        
        // Add NFT Modal
        function showAddModal() {
            document.getElementById('addModal').classList.add('show');
        }
        
        function closeAddModal() {
            document.getElementById('addModal').classList.remove('show');
        }
        
        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const contract = document.getElementById('contractAddress').value.trim();
            const tokenId = document.getElementById('tokenId').value.trim();
            const name = document.getElementById('agentName').value.trim();
            
            // Add to monitored list
            monitoredNfts.push({
                contract,
                tokenId,
                name: name || null,
                dashIdentity: null,
                status: 'unregistered',
                lastSync: null,
                docCount: 0,
                totalSize: '0 KB'
            });
            
            // Save to localStorage
            localStorage.setItem(`peg_nfts_${userAddress.toLowerCase()}`, JSON.stringify(monitoredNfts));
            
            // Re-render
            renderNfts();
            closeAddModal();
            
            // Reset form
            document.getElementById('addForm').reset();
        });
        
        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('show');
                }
            });
        });
        
        // Handle wallet changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    userAddress = null;
                    localStorage.removeItem('peg_gg_address');
                    location.reload();
                } else {
                    setConnected(accounts[0]);
                }
            });
        }
    </script>
</body>
</html>
